<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title}"></title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .book-item {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }
        .total-section {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 0.375rem;
            font-weight: bold;
        }
        .btn-remove {
            margin-top: 1.75rem;
        }
        .book-actions {
            margin-top: 1.75rem;
        }
        .existing-book-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .existing-book-item:hover {
            background-color: #f8f9fa;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .quantity-input {
            width: 80px;
            text-align: center;
        }
    </style>
</head>
<body>
<nav th:replace="~{navbar :: navbar}"></nav>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0" th:text="${title}"></h4>
                </div>
                <div class="card-body">
                    <form id="storeForm" th:action="@{/bookstores/saveBookStore}" method="post">
                        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–≥–∞–∑–∏–Ω–µ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="storeName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ *</label>
                                    <input type="text" class="form-control" id="storeName" name="name" th:value="${store?.name}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="storePhone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                                    <input type="tel" class="form-control" id="storePhone" name="phone" th:value="${store?.phone}" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="storeAddress" class="form-label">–ê–¥—Ä–µ—Å –º–∞–≥–∞–∑–∏–Ω–∞ *</label>
                            <textarea class="form-control" id="storeAddress" name="address" rows="3" th:text="${store?.address}" required></textarea>
                        </div>

                        <hr class="my-4">

                        <!-- –°–µ–∫—Ü–∏—è –∫–Ω–∏–≥ -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>–°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥</h5>
                            <div>
                                <button type="button" class="btn btn-success btn-sm me-2" data-bs-toggle="modal" data-bs-target="#newBookModal">
                                    + –ù–æ–≤–∞—è –∫–Ω–∏–≥–∞
                                </button>
                                <button type="button" class="btn btn-info btn-sm text-white" data-bs-toggle="modal" data-bs-target="#existingBooksModal">
                                    üìö –í—ã–±—Ä–∞—Ç—å –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
                                </button>
                            </div>
                        </div>

                        <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –æ –∫–Ω–∏–≥–∞—Ö -->
                        <div id="booksDataContainer" style="display: none;">
                            <!-- –î–∞–Ω–Ω—ã–µ –æ –∫–Ω–∏–≥–∞—Ö –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –∫–∞–∫ hidden inputs -->
                            <input type="hidden" th:value="${store?.id}"/>
                        </div>

                        <div id="booksContainer">
                            <!-- –ö–Ω–∏–≥–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            <div th:each="bookItem, status : ${store?.bookItems}" class="book-item">
                                <div class="row align-items-start">
                                    <div class="col-md-5">
                                        <div class="mb-3">
                                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ *</label>
                                            <input type="text" class="form-control book-title" th:value="${bookItem.book.title}" readonly>
                                            <input type="hidden" class="book-id" th:value="${bookItem.book.id}">
                                            <small class="text-muted book-author" th:text="${bookItem.book.author}"></small>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label class="form-label">–¶–µ–Ω–∞ (—Ä—É–±.) *</label>
                                            <input type="number" class="form-control book-price" th:value="${bookItem.price}" step="0.01" min="0" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                                            <div class="quantity-controls">
                                                <input type="number" class="form-control quantity-input book-quantity" th:value="${bookItem.quantity}" min="1" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="book-actions">
                                            <button type="button" class="btn btn-danger btn-remove w-100">
                                                –£–¥–∞–ª–∏—Ç—å
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <div class="book-item-total text-muted small">
                                            –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏: <span class="item-total" th:text="${#numbers.formatDecimal(bookItem.price * bookItem.quantity, 1, 2)}">0.00</span> —Ä—É–±.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –°—É–º–º–∞ -->
                        <div class="total-section mt-4">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="d-flex justify-content-between">
                                        <span>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                                        <span id="totalAmount" th:text="${#numbers.formatDecimal(store?.totalCost ?: 0, 1, 2)} + ' —Ä—É–±.'">0.00 —Ä—É–±.</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex justify-content-between">
                                        <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥:</span>
                                        <span id="totalQuantity" th:text="${store?.totalQuantity ?: 0} + ' —à—Ç.'">0 —à—Ç.</span>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <small class="text-muted" id="bookCount" th:text="'–ü–æ–∑–∏—Ü–∏–π: ' + (${store?.bookItems?.size} ?: 0)">–ü–æ–∑–∏—Ü–∏–π: 0</small>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="clearForm()">
                                –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                            </button>
                            <button type="submit" class="btn btn-primary">
                                –°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∫–Ω–∏–≥–∏ -->
<div class="modal fade" id="newBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–Ω–∏–≥–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newBookForm" th:action="@{/books/saveBook}" th:object="${book}" method="post">
                    <div th:if="${param.success}" class="alert alert-success">
                        –ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!
                    </div>
                    <div class="mb-3">
                        <label for="newBookTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ *</label>
                        <input th:field="*{title}" type="text" class="form-control" id="newBookTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="newBookAuthor" class="form-label">–ê–≤—Ç–æ—Ä *</label>
                        <input th:field="*{author}" type="text" class="form-control" id="newBookAuthor" name="author" required>
                    </div>
                    <div class="mb-3">
                        <label for="newBookPrice" class="form-label">–¶–µ–Ω–∞ (—Ä—É–±.) *</label>
                        <input th:field="*{price}" type="number" class="form-control" id="newBookPrice" name="price" step="0.01" min="0" required>
                    </div>
                    <input type="hidden" th:field="*{id}"/>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveNewBookBtn" onclick="saveNewBook()">
                    <span class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–Ω–∏–≥—É
                </button>

            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–Ω–∏–≥ -->
<div class="modal fade" id="existingBooksModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–í—ã–±–æ—Ä –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –∫–Ω–∏–≥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="searchBooks" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞–≤—Ç–æ—Ä—É...">
                </div>
                <div id="existingBooksList" style="max-height: 400px; overflow-y: auto;">
                    <!-- –°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ –∏–∑ ModelAndView -->
                    <div th:each="book : ${availableBooks}" class="existing-book-item border-bottom p-3">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-1 existing-book-title" th:text="${book.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏</h6>
                                <small class="text-muted existing-book-author" th:text="${book.author}">–ê–≤—Ç–æ—Ä</small>
                                <br>
                            </div>
                            <div class="col-md-2">
                                <span class="existing-book-price fw-bold" th:text="${#numbers.formatDecimal(book.price, 1, 2)} + ' —Ä—É–±.'">0.00 —Ä—É–±.</span>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-primary btn-sm w-100 add-existing-book"
                                        th:data-book-id="${book.id}"
                                        th:data-book-title="${book.title}"
                                        th:data-book-author="${book.author}"
                                        th:data-book-price="${book.price}">
                                    –î–æ–±–∞–≤–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>
                    <div th:if="${#lists.isEmpty(availableBooks)}" class="text-center text-muted p-4">
                        –ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –®–∞–±–ª–æ–Ω –¥–ª—è –∫–Ω–∏–≥–∏ –≤ —Å–ø–∏—Å–∫–µ -->
<template id="bookTemplate">
    <div class="book-item">
        <div class="row align-items-start">
            <div class="col-md-5">
                <div class="mb-3">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ *</label>
                    <input type="text" class="form-control book-title" required readonly>
                    <input type="hidden" class="book-id">
                    <small class="text-muted book-author"></small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-3">
                    <label class="form-label">–¶–µ–Ω–∞ (—Ä—É–±.) *</label>
                    <input type="number" class="form-control book-price" step="0.01" min="0" required>
                </div>
            </div>
            <div class="col-md-3">
                <div class="mb-3">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                    <div class="quantity-controls">
                        <button type="button" class="btn btn-outline-secondary btn-sm quantity-decrease">-</button>
                        <input type="number" class="form-control quantity-input book-quantity" value="1" min="1" required>
                        <button type="button" class="btn btn-outline-secondary btn-sm quantity-increase">+</button>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="book-actions">
                    <button type="button" class="btn btn-danger btn-remove w-100">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="book-item-total text-muted small">
                    –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏: <span class="item-total">0.00</span> —Ä—É–±.
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Bootstrap JS –∏ Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // –ü–æ–ª–Ω—ã–π JavaScript –∫–æ–¥ –¥–ª—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞

    let bookCounter = 0;
    let selectedBooks = new Map();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–Ω–∏–≥ –∏–∑ Thymeleaf
        initializeExistingBooks();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–Ω–∏–≥
        document.getElementById('existingBooksModal').addEventListener('show.bs.modal', function() {
            document.getElementById('searchBooks').value = '';
            filterExistingBooks();
        });

        // –ü–æ–∏—Å–∫ –∫–Ω–∏–≥
        document.getElementById('searchBooks').addEventListener('input', filterExistingBooks);

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –Ω–æ–≤–æ–π –∫–Ω–∏–≥–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const newBookModal = document.getElementById('newBookModal');
        newBookModal.addEventListener('hidden.bs.modal', function() {
            document.getElementById('newBookForm').reset();
        });
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–Ω–∏–≥ –∏–∑ –¥–∞–Ω–Ω—ã—Ö Thymeleaf
    function initializeExistingBooks() {
        const addButtons = document.querySelectorAll('.add-existing-book');
        addButtons.forEach(button => {
            button.addEventListener('click', function() {
                const bookData = {
                    id: this.getAttribute('data-book-id'),
                    title: this.getAttribute('data-book-title'),
                    author: this.getAttribute('data-book-author'),
                    price: parseFloat(this.getAttribute('data-book-price'))
                };
                addBookToStore(bookData);

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('existingBooksModal'));
                modal.hide();
            });
        });
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–Ω–∏–≥–∏ —á–µ—Ä–µ–∑ AJAX
    async function saveNewBook() {
        const form = document.getElementById('newBookForm');
        const saveBtn = document.getElementById('saveNewBookBtn');
        //const spinner = saveBtn.querySelector('.spinner-border');
        const originalText = saveBtn.textContent;

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏
        const bookData = {
            title: document.getElementById('newBookTitle').value.trim(),
            author: document.getElementById('newBookAuthor').value.trim(),
            price: parseFloat(document.getElementById('newBookPrice').value)
        };

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        if (!bookData.title) {
            showAlert('newBookAlert', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏', 'danger');
            return;
        }

        if (!bookData.author) {
            showAlert('newBookAlert', '–í–≤–µ–¥–∏—Ç–µ –∞–≤—Ç–æ—Ä–∞ –∫–Ω–∏–≥–∏', 'danger');
            return;
        }

        if (!bookData.price || bookData.price <= 0) {
            showAlert('newBookAlert', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É', 'danger');
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        saveBtn.disabled = true;
        //spinner.style.display = 'inline-block';
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        try {
            const response = await fetch('/books/create-ajax', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bookData)
            });

            const responseData = await response.json();

            if (!response.ok) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                if (response.status === 400) {
                    const errorMessages = Object.values(responseData).join(', ');
                    throw new Error(errorMessages || '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
                }
                throw new Error(responseData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            }

            // –£—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            const savedBook = responseData;

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–Ω–∏–≥—É –≤ –º–∞–≥–∞–∑–∏–Ω
            addBookToStore({
                id: savedBook.id,
                title: savedBook.title,
                author: savedBook.author,
                price: savedBook.price,
                quantity: 1
            });

            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('newBookForm').reset();

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('newBookModal'));
            modal.hide();
        }, 1000);

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–Ω–∏–≥–∏:', error);
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            saveBtn.disabled = false;
            //spinner.style.display = 'none';
            saveBtn.textContent = originalText;
        }
    }

    function addBookToAvailableList(book) {
        const container = document.getElementById('existingBooksList');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (!container) {
            console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–ø–∏—Å–∫–∞ –∫–Ω–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ)');
            return;
        }

        // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        const noBooksMessage = container.querySelector('.text-center.text-muted');
        if (noBooksMessage) {
            noBooksMessage.remove();
        }

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∫–Ω–∏–≥–∏
        const bookElement = document.createElement('div');
        bookElement.className = 'existing-book-item border-bottom p-3';
        bookElement.innerHTML = `
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-1 existing-book-title">${book.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h6>
                    <small class="text-muted existing-book-author">${book.author || '–ê–≤—Ç–æ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω'}</small>
                    <br>
                </div>
                <div class="col-md-2">
                    <span class="existing-book-price fw-bold">${(book.price || 0).toFixed(2)} —Ä—É–±.</span>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-primary btn-sm w-100 add-existing-book"
                            data-book-id="${book.id}"
                            data-book-title="${book.title}"
                            data-book-author="${book.author}"
                            data-book-price="${book.price}">
                        –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        `;

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å"
        const addButton = bookElement.querySelector('.add-existing-book');
        addButton.addEventListener('click', function() {
            const bookData = {
                id: this.getAttribute('data-book-id'),
                title: this.getAttribute('data-book-title'),
                author: this.getAttribute('data-book-author'),
                price: parseFloat(this.getAttribute('data-book-price'))
            };
            addBookToStore(bookData);

            const modal = bootstrap.Modal.getInstance(document.getElementById('existingBooksModal'));
            modal.hide();
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–∏–≥—É –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
        container.insertBefore(bookElement, container.firstChild);

        console.log('–ù–æ–≤–∞—è –∫–Ω–∏–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–∏–≥–∏ –≤ –º–∞–≥–∞–∑–∏–Ω
    function addBookToStore(bookData) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–∏ –∫–Ω–∏–≥–∞ —É–∂–µ
        if (selectedBooks.has(bookData.id)) {
            alert('–≠—Ç–∞ –∫–Ω–∏–≥–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫');
            return;
        }

        const template = document.getElementById('bookTemplate');
        const clone = template.content.cloneNode(true);
        const bookElement = clone.querySelector('.book-item');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
        const bookUniqueId = 'book_' + bookData.id + '_' + Date.now();
        bookElement.dataset.bookId = bookUniqueId;

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏
        bookElement.querySelector('.book-id').value = bookData.id;
        bookElement.querySelector('.book-title').value = bookData.title || '';
        bookElement.querySelector('.book-price').value = bookData.price || '';
        bookElement.querySelector('.book-author').textContent = bookData.author || '';

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥
        selectedBooks.set(bookData.id, {
            element: bookElement,
            quantity: 1
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –∫–Ω–∏–≥–∏
        const removeBtn = bookElement.querySelector('.btn-remove');
        removeBtn.addEventListener('click', function() {
            selectedBooks.delete(bookData.id);
            bookElement.remove();
            updateBooksDataContainer();
            calculateTotal();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        const priceInput = bookElement.querySelector('.book-price');
        const quantityInput = bookElement.querySelector('.book-quantity');

        priceInput.addEventListener('input', function() {
            calculateBookItemTotal.call(bookElement);
            updateBooksDataContainer();
        });

        quantityInput.addEventListener('input', function() {
            selectedBooks.get(bookData.id).quantity = quantityInput.value;
            calculateBookItemTotal.call(bookElement);
            updateBooksDataContainer();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        const decreaseBtn = bookElement.querySelector('.quantity-decrease');
        const increaseBtn = bookElement.querySelector('.quantity-increase');

        decreaseBtn.addEventListener('click', function() {
            const currentValue = parseInt(quantityInput.value) || 1;
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
                selectedBooks.get(bookData.id).quantity = quantityInput.value;
                calculateBookItemTotal.call(bookElement);
                updateBooksDataContainer();
            }
        });

        increaseBtn.addEventListener('click', function() {
            const currentValue = parseInt(quantityInput.value) || 1;
            quantityInput.value = currentValue + 1;
            selectedBooks.get(bookData.id).quantity = quantityInput.value;
            calculateBookItemTotal.call(bookElement);
            updateBooksDataContainer();
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–∏–≥—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        document.getElementById('booksContainer').appendChild(bookElement);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–∞–Ω–Ω—ã—Ö
        updateBooksDataContainer();

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏
        calculateBookItemTotal.call(bookElement);
        calculateTotal();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–Ω–∏–≥
    function updateBooksDataContainer() {
        const container = document.getElementById('booksDataContainer');
        container.innerHTML = '';

        selectedBooks.forEach((bookData, bookId) => {
            const bookElement = bookData.element;
            const price = bookElement.querySelector('.book-price').value;
            const quantity = bookElement.querySelector('.book-quantity').value;

            const bookIdInput = document.createElement('input');
            bookIdInput.type = 'hidden';
            bookIdInput.name = 'bookItems[' + bookId + '].bookId';
            bookIdInput.value = bookId;
            container.appendChild(bookIdInput);

            const priceInput = document.createElement('input');
            priceInput.type = 'hidden';
            priceInput.name = 'bookItems[' + bookId + '].price';
            priceInput.value = price;
            container.appendChild(priceInput);

            const quantityInput = document.createElement('input');
            quantityInput.type = 'hidden';
            quantityInput.name = 'bookItems[' + bookId + '].quantity';
            quantityInput.value = quantity;
            container.appendChild(quantityInput);
        });
    }

    // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–Ω–∏–≥–∏
    function calculateBookItemTotal() {
        const bookElement = this.closest('.book-item') || this;
        const priceInput = bookElement.querySelector('.book-price');
        const quantityInput = bookElement.querySelector('.book-quantity');
        const itemTotalElement = bookElement.querySelector('.item-total');

        const price = parseFloat(priceInput.value) || 0;
        const quantity = parseInt(quantityInput.value) || 0;
        const itemTotal = price * quantity;

        itemTotalElement.textContent = itemTotal.toFixed(2);
        calculateTotal();
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–π —Å—É–º–º—ã –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    function calculateTotal() {
        const bookItems = document.querySelectorAll('.book-item');
        let totalAmount = 0;
        let totalQuantity = 0;
        let validBooks = 0;

        bookItems.forEach(item => {
            const priceInput = item.querySelector('.book-price');
            const titleInput = item.querySelector('.book-title');
            const quantityInput = item.querySelector('.book-quantity');

            const price = parseFloat(priceInput.value) || 0;
            const title = titleInput.value.trim();
            const quantity = parseInt(quantityInput.value) || 0;

            if (title && price > 0 && quantity > 0) {
                totalAmount += price * quantity;
                totalQuantity += quantity;
                validBooks++;
            }
        });

        document.getElementById('totalAmount').textContent = totalAmount.toFixed(2) + ' —Ä—É–±.';
        document.getElementById('totalQuantity').textContent = totalQuantity + ' —à—Ç.';
        document.getElementById('bookCount').textContent = '–ü–æ–∑–∏—Ü–∏–π: ' + validBooks;
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–Ω–∏–≥ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    function filterExistingBooks() {
        const searchTerm = document.getElementById('searchBooks').value.toLowerCase();
        const bookItems = document.querySelectorAll('.existing-book-item');

        bookItems.forEach(item => {
            const title = item.querySelector('.existing-book-title').textContent.toLowerCase();
            const author = item.querySelector('.existing-book-author').textContent.toLowerCase();

            if (title.includes(searchTerm) || author.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
    function showAlert(containerId, message, type) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.error('Container not found:', containerId);
            return;
        }

        container.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show">
                ${message}
                <button type="button" class="btn-close" onclick="hideAlert('${containerId}')"></button>
            </div>
        `;
        container.style.display = 'block';
    }

    function hideAlert(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
            container.style.display = 'none';
            container.innerHTML = '';
        }
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    function clearForm() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É?')) {
            document.getElementById('storeForm').reset();
            document.getElementById('booksContainer').innerHTML = '';
            document.getElementById('booksDataContainer').innerHTML = '';
            selectedBooks.clear();
            bookCounter = 0;
            calculateTotal();
        }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–Ω–∏–≥–∏
    function validateBook() {
        calculateTotal();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
    function initializeRemoveButtons() {
        const removeButtons = document.querySelectorAll('.btn-remove');
        removeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const bookItem = this.closest('.book-item');
                bookItem.remove();
                calculateTotal();
            });
        });
    }
</script>
</body>
</html>